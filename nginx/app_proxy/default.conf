{% for key, item in pillar['nginx']['forward'].items() if pillar['nginx'] is defined and pillar['nginx'] is not null %}

stream {
    upstream {{ key }} {
        server {{ item['to_host'] }}:{{ item['to_port'] }};
    }
    server {
        server_name {{ item['from_host'] | default('localhost', true) }}

        listen {{ item['from_port'] | default('80 default_server', true) }};
        listen [::]:{{ item['from_port'] | default('80 default_server', true) }};

        proxy_pass    {{ key }};
    }
}

{% endfor %}
