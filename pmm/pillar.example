# https://github.com/percona/pmm-doc/blob/main/docs/_images/PMM_Architecture_Client_Server.jpg
{% set gf_path_var_lib = '/var/lib/grafana' %}
{% set gf_path_provisioning = '/etc/grafana/provisioning'  %}
pmm:
  docker-ce_version: 5:20.10.8*
  acme_account: example.com
  name: pmm.example.com
  admin_password: 'XXXXXXXXXXXXXXXX'
  plugins: grafana-image-renderer
  image: percona/pmm-server:2.26
  gf_path_var_lib: {{ gf_path_var_lib }}
  gf_path_provisioning: {{ gf_path_provisioning }}
  config: |
    [server]
    root_url = https://pmm.example.com/graph/
    enable_gzip = true
    [dashboards]
    # Path to the default home dashboard. If this value is empty, then Grafana uses StaticRootPath + "dashboards/home.json"
    default_home_dashboard_path = /usr/share/percona-dashboards/panels/pmm-app/dist/dashboards/Insight/Home_Dashboard.json
    [users]
    # Path to a custom home page. Users are only redirected to this if the default home dashboard is used. It should match a frontend route and contain a leading slash.
    home_page = d/pmm-home/home-dashboard
    [paths]
    # Directory where grafana will automatically scan and look for plugins
    plugins = /srv/grafana/plugins
    provisioning = {{ gf_path_provisioning }}
    [plugins]
    # Enter a comma-separated list of plugin identifiers to identify plugins that are allowed to be loaded even if they lack a valid signature.
    allow_loading_unsigned_plugins = vertamedia-clickhouse-datasource,pmm-app,pmm-check-panel-home,pmm-update,pmm-qan-app-panel,pmm-pt-summary-panel,pmm-pt-summary-datasource
    [auth.gitlab]
    enabled = true
    allow_sign_up = true
    client_id = 7a08f6925bece27edabd5b9611ad6cdc639e1806ac1686001501098aa7770052
    client_secret = 1fb4662fc6bd9c07b07dbea683361328412d0fb808beaf81c4c234bd7f5b1c2e
    scopes = read_api
    auth_url = https://gitlab.example.com/oauth/authorize
    token_url = https://gitlab.example.com/oauth/token
    api_url = https://gitlab.example.com/api/v4
    allowed_groups = pmm
    [unified_alerting]
    enabled = false
    [alerting]
    enabled = true
  env_vars:
    DISABLE_UPDATES: true
  datasources:
    apiVersion: 1
    datasources:
      - name: "prometheus.example.org"
        type: prometheus
        access: proxy
        url: https://prometheus.example.com
        basicAuth: true
        basicAuthUser: username
        basicAuthPassword: XXXXXXXXXXXXXXXXXXXXXXX
        editable: true
  notifiers:
    apiVersion: 1
    notifiers:
      - name: telegram1
        type: telegram
        uid: telega1
        org_id: 1
        is_default: true
        send_reminder: false
        disable_resolve_message: false
        settings:
          chatid: '-123456789'
          uploadImage: true
          bottoken: '1234567890:XXXXXXXXX-YYYYYYYYYYYYYYYY-ZZZZZZZZ'
  dashboards:
    provisioning_config:
      apiVersion: 1
      providers:
        - name: dashboards
          orgId: 1
          type: file
          disableDeletion: false
          updateIntervalSeconds: 10
          allowUiUpdates: true
          options:
            path: {{ gf_path_var_lib }}/dashboards
            foldersFromFilesStructure: true
    dashboard_definitions:
      - template: salt://pmm/files/garafana/dashboard_templates/disk_memory_cpu_mysql-replica.json
        {%- set folder = 'DATA-CENTER-NAME' %}
        {%- set node_name = 'node1.example.com' %}
        path: {{ gf_path_var_lib }}/dashboards/{{ folder }}/{{ node_name }}.json
        context:
          node_name: {{ node_name }}
          replication_panel: false
          board_name: {{ node_name }}
      - template: salt://pmm/files/garafana/dashboard_templates/pxc_cluster.json
        {%- set folder = 'DATA-CENTER-NAME' %}
        {%- set brand = 'PREFIX-EXAMPLE' %}
        {%- set wsrep_cluster_name = 'pxc-example-cluster' %}
        path: {{ gf_path_var_lib }}/dashboards/{{ folder }}/{{ wsrep_cluster_name }}.json
        context:
          wsrep_cluster_name: {{ wsrep_cluster_name }}
          cluster_size: 3
          brand: {{ brand }}
          board_name: '{{ brand }} Percona XtraDB Cluster'
